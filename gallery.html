<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Quadspectat - 3D Model Gallery</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.117/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.117/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    html, body, #cesiumContainer { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    .panel { background: rgba(20, 20, 20, 0.85); backdrop-filter: blur(5px); color: white; padding: 15px; box-sizing: border-box; border-radius: 8px; }
    #left-column { position: absolute; top: 0; left: 0; width: 260px; height: 100%; background: rgba(20, 20, 20, 0.85); backdrop-filter: blur(5px); display: flex; flex-direction: column; gap: 15px; padding: 15px; box-sizing: border-box; color: white; transition: transform 0.3s ease; z-index: 20; }
    #gallery { flex-shrink: 0; }
    #gallery, #data-layers { border-bottom: 1px solid #555; padding-bottom: 15px;}
    #gallery h2, .control-panel h4 { margin-top: 0; color: white; }
    #gallery ul, #dataLayersList { list-style: none; padding: 0; margin: 0; }
    #gallery li, #dataLayersList li { padding: 10px; border-radius: 4px; transition: background-color 0.2s; font-size: 14px; cursor: pointer; }
    #gallery li:hover, #gallery li.active { background-color: #007bff; }
    #dataLayersList li { display: flex; align-items: center; background-color: rgba(0,0,0,0.2); margin-bottom: 5px; }
    #dataLayersList li span.layer-name { flex-grow: 1; margin: 0 8px; }
    #dataLayersList .layer-controls { display: flex; align-items: center; gap: 8px; }
    #dataLayersList .layer-controls .visibility-toggle svg { width: 18px; height: 18px; fill: #fff; cursor: pointer; }
    #dataLayersList button { background: #c0392b; color: white; border: none; border-radius: 3px; padding: 2px 6px; cursor: pointer; }
    #scrollable-controls { overflow-y: auto; flex-grow: 1; }
    .toolbar-group { display: flex; gap: 10px; }
    #toolbars { position: absolute; top: 15px; left: 290px; display: flex; flex-direction: column; gap: 10px; z-index: 10; }
    #toolbar button, #toolbar a { background-color: #444; color: white; border: 1px solid #666; padding: 8px 12px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center; }
    #toolbar button.active { background-color: #007bff; border-color: #007bff; }
    #recenterBtn, #backBtn { background-color: #007bff; border-color: #007bff; }
    #recenterBtn:hover, #backBtn:hover { background-color: #0056b3; }
    #backBtn { text-decoration: none; }
    .control-panel { padding: 10px 15px; background: none; }
    .control-panel label { display: block; margin-bottom: 5px; font-size: 14px; }
    .control-panel input[type="range"], .control-panel input[type="file"] { width: 100%; }
    #measurement-display { position: absolute; top: 135px; left: 290px; font-size: 16px; text-align: left; line-height: 1.5; white-space: pre; z-index: 10; padding: 10px; }
    #share-panel { display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #555; }
    #share-panel h4 { font-size: 1rem; margin-bottom: 10px; }
    #share-icons { display: flex; justify-content: space-around; }
    #share-icons a { color: white; }
    #share-icons svg { width: 24px; height: 24px; fill: white; cursor: pointer; transition: opacity 0.2s; }
    #share-icons svg:hover { opacity: 0.7; }
    #mobile-menu-btn { display: none; }

    @media (max-width: 768px) {
        #left-column { transform: translateX(-100%); }
        #left-column.open { transform: translateX(0); }
        #toolbars { left: 80px; }
        #measurement-display { left: 15px; top: 180px; }
        #mobile-menu-btn {
            display: block; position: absolute; top: 15px; left: 15px; z-index: 30;
            background-color: #444; color: white; border: 1px solid #666; padding: 8px 12px; border-radius: 4px; cursor: pointer;
        }
    }
  </style>
</head>
<body>
  
  <div id="cesiumContainer"></div>
  <button id="mobile-menu-btn">Menu</button>

  <div id="left-column">
    <div id="gallery">
      <h2>Model Gallery</h2>
      <ul id="modelList"></ul>
      <div id="share-panel">
          <h4>Share Model</h4>
          <div id="share-icons">
              <a id="copyLinkBtn" title="Copy Link"><svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></a>
              <a id="whatsappShareBtn" target="_blank" title="Share on WhatsApp"><svg viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.487 5.235 3.487 8.413.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.433-9.89-9.889-9.89-5.452 0-9.887 4.434-9.889 9.886-.001 2.269.654 4.288 1.902 6.046l-1.105 4.029 4.029-1.106z"/></svg></a>
              <a id="gmailShareBtn" target="_blank" title="Share via Email"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg></a>
          </div>
      </div>
    </div>
    <div id="scrollable-controls">
      <div id="data-layers" class="control-panel">
        <h4>Data Layers</h4>
        <ul id="dataLayersList"></ul>
        <hr style="border-color: #555; margin: 15px 0;">
        <input type="file" id="fileInput" accept=".kmz,.kml,.glb,.gltf">
      </div>
      <div id="lighting-controls" class="control-panel">
        <h4>Lighting & Detail</h4>
        <label for="detailLevel">Detail Level</label>
        <input type="range" id="detailLevel" min="2" max="32" value="16" step="1">
        <label for="brightness">Brightness</label>
        <input type="range" id="brightness" min="0" max="3" value="1" step="0.05">
        <label for="contrast">Contrast</label>
        <input type="range" id="contrast" min="0" max="3" value="1" step="0.05">
        <label for="gamma">Gamma</label>
        <input type="range" id="gamma" min="0.1" max="4" value="2.2" step="0.05">
        <label for="saturation">Saturation</label>
        <input type="range" id="saturation" min="0" max="3" value="1" step="0.05">
        <label for="whites">Whites</label>
        <input type="range" id="whites" min="-0.5" max="0.5" value="0" step="0.01">
        <label for="whiteBalance">White Balance</label>
        <input type="range" id="whiteBalance" min="-1" max="1" value="0" step="0.05">
      </div>
    </div>
  </div>

  <div id="toolbars">
      <div id="toolbar" class="panel toolbar-group">
        <a href="index.html" id="backBtn">Back</a>
        <button id="recenterBtn">Recenter</button>
        <button id="fullscreenBtn" title="Fullscreen">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zM.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/></svg>
        </button>
        <button id="distanceBtn">Distance</button>
        <button id="areaBtn">Area</button>
        <button id="volumeBtn">Volume</button>
        <button id="clearMeasurementsBtn">Clear</button>
      </div>
  </div>
  
  <div id="measurement-display" class="panel">Select a tool to begin.</div>

  <script>
    window.CESIUM_BASE_URL = 'https://cesium.com/downloads/cesiumjs/releases/1.117/Build/Cesium/';

    // ===============================================
    // PART 1: YOUR CUSTOM CONFIGURATION
    // ===============================================
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJmYTNlODhkNC0zOTNlLTRkMmEtODU2MS04ZGQ3NDFkNGU4NmQiLCJpZCI6MTE5NjI3LCJpYXQiOjE2NzIxNjg2MjN9.iQ-WY4qZZoK8NCgheHh1m0gM4GBWsaMl7UTMcufyl7Q';

    const models = [
      { 
        id: "production_3",
        name: "Givat Haviva", 
        url: "https://quadspectat-models.fra1.cdn.digitaloceanspaces.com/Givat%20Haviva/Scene/Cesium.json",
      },
      // --- ADD FUTURE MODELS HERE ---
      /*
      {
        id: "your_next_model_id",
        name: "Your Next Model's Name", 
        url: "PASTE_THE_URL_TO_THE_NEXT_MODEL_JSON_FILE_HERE",
      }
      */
    ];

    // ===============================================
    // PART 2: SETUP THE VIEWER & UI
    // ===============================================
    let currentTileset = null;
    const modelListElement = document.getElementById('modelList');

    async function main() {
      try {
        const viewer = new Cesium.Viewer('cesiumContainer', {
          terrainProvider: await Cesium.Terrain.fromWorldTerrain(),
          infoBox: false, 
          selectionIndicator: false,
          baseLayerPicker: true, 
        });

        viewer.canvas.oncontextmenu = (e) => e.preventDefault();
        viewer.scene.globe.enableLighting = true;

        models.forEach((model) => {
          const listItem = document.createElement('li');
          listItem.id = `model-list-item-${model.id}`;
          listItem.textContent = model.name;
          listItem.onclick = () => {
            loadModel(viewer, model);
            document.querySelectorAll('#modelList li').forEach(el => el.classList.remove('active'));
            listItem.classList.add('active');
          };
          modelListElement.appendChild(listItem);
        });

        document.getElementById('recenterBtn').onclick = () => { if (currentTileset) viewer.zoomTo(currentTileset); };
        
        setupShareControls(viewer);
        setupFullscreenButton();
        setupInteractionTools(viewer);
        setupMobileMenu();
        setupDataLayers(viewer);
        setupLightingControls(viewer);

        const urlParams = new URLSearchParams(window.location.search);
        const requestedModelId = urlParams.get('model');
        let initialModelId = models.length > 0 ? models[0].id : null;

        if (requestedModelId) {
            const foundModel = models.find(m => m.id === requestedModelId);
            if (foundModel) initialModelId = foundModel.id;
        }
        
        if (initialModelId) {
            document.getElementById(`model-list-item-${initialModelId}`).click();
        }
        
      } catch (error) { console.error(`An error occurred: ${error}`); }
    }

    async function loadModel(viewer, model) {
        if (currentTileset) viewer.scene.primitives.remove(currentTileset);
        try {
            const detailLevel = document.getElementById('detailLevel').value;
            const tileset = await Cesium.Cesium3DTileset.fromUrl(model.url, {
                maximumScreenSpaceError: parseFloat(detailLevel)
            });
            tileset.modelId = model.id; 
            if (model.lon && model.lat) {
                const position = Cesium.Cartesian3.fromDegrees(model.lon, model.lat, model.height || 0);
                tileset.modelMatrix = Cesium.Transforms.eastNorthUpToFixedFrame(position);
            }
            viewer.scene.primitives.add(tileset);
            await viewer.zoomTo(tileset);
            currentTileset = tileset;
            document.getElementById('share-panel').style.display = 'block';
        } catch (error) {
            console.error(`Failed to load model from ${model.url}. Full error:`, error);
        }
    }
    
    // ===============================================
    // PART 3: SETUP FUNCTIONS
    // ===============================================
    function setupFullscreenButton() {
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        fullscreenBtn.onclick = () => {
            if (Cesium.Fullscreen.fullscreen) {
                Cesium.Fullscreen.exitFullscreen();
            } else {
                Cesium.Fullscreen.requestFullscreen(document.getElementById('cesiumContainer'));
            }
        };
    }
    
    function setupMobileMenu() {
        const menuBtn = document.getElementById('mobile-menu-btn');
        const leftColumn = document.getElementById('left-column');
        menuBtn.onclick = () => {
            leftColumn.classList.toggle('open');
        };
    }

    function setupShareControls(viewer) {
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        const whatsappShareBtn = document.getElementById('whatsappShareBtn');
        const gmailShareBtn = document.getElementById('gmailShareBtn');

        const getShareUrl = () => {
            if (currentTileset && currentTileset.modelId) {
                const url = new URL(window.location.href);
                url.searchParams.set('model', currentTileset.modelId);
                return url.href;
            }
            return null;
        };

        copyLinkBtn.onclick = () => {
            const url = getShareUrl();
            if (url) {
                navigator.clipboard.writeText(url).then(() => alert('Link copied!'), () => alert('Failed to copy.'));
            }
        };

        whatsappShareBtn.onclick = () => {
            const url = getShareUrl();
            if(url) {
                whatsappShareBtn.href = `https://api.whatsapp.com/send?text=${encodeURIComponent('Check out this 3D model: ' + url)}`;
            }
        };
        
        gmailShareBtn.onclick = () => {
            const url = getShareUrl();
            if(url) {
                const subject = "Check out this 3D Model";
                const body = `I wanted to share this interactive 3D model with you:\n\n${url}`;
                gmailShareBtn.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            }
        };
    }
    
    function setupLightingControls(viewer) {
        const detailSlider = document.getElementById('detailLevel');
        const brightness = document.getElementById('brightness');
        const contrast = document.getElementById('contrast');
        const gamma = document.getElementById('gamma');
        const saturation = document.getElementById('saturation');
        const whites = document.getElementById('whites');
        const whiteBalance = document.getElementById('whiteBalance');

        const stage = new Cesium.PostProcessStage({
            fragmentShader: `
              uniform sampler2D colorTexture; in vec2 v_textureCoordinates;
              uniform float u_brightness; uniform float u_contrast; uniform float u_gamma; 
              uniform float u_saturation; uniform float u_whites; uniform float u_whiteBalance;
              void main(void) {
                vec3 warm_filter = vec3(1.0, 0.93, 0.86); vec3 cool_filter = vec3(0.86, 0.93, 1.0);
                vec4 color = texture(colorTexture, v_textureCoordinates); vec3 rgb = color.rgb;
                rgb = pow(rgb, vec3(1.0 / u_gamma));
                rgb = (rgb - 0.5) * u_contrast + 0.5;
                rgb *= u_brightness;
                float gray = dot(rgb, vec3(0.299, 0.587, 0.114));
                rgb = mix(vec3(gray), rgb, u_saturation);
                rgb += u_whites;
                if (u_whiteBalance > 0.0) { rgb = mix(rgb, rgb * warm_filter, u_whiteBalance); } 
                else { rgb = mix(rgb, rgb * cool_filter, -u_whiteBalance); }
                out_FragColor = vec4(clamp(rgb, 0.0, 1.0), color.a);
              }`,
            uniforms: {
              u_brightness: parseFloat(brightness.value), u_contrast: parseFloat(contrast.value),
              u_gamma: parseFloat(gamma.value), u_saturation: parseFloat(saturation.value),
              u_whites: parseFloat(whites.value), u_whiteBalance: parseFloat(whiteBalance.value)
            }
        });
        viewer.scene.postProcessStages.add(stage);

        const updateUniforms = () => {
            stage.uniforms.u_brightness = parseFloat(brightness.value);
            stage.uniforms.u_contrast = parseFloat(contrast.value);
            stage.uniforms.u_gamma = parseFloat(gamma.value);
            stage.uniforms.u_saturation = parseFloat(saturation.value);
            stage.uniforms.u_whites = parseFloat(whites.value);
            stage.uniforms.u_whiteBalance = parseFloat(whiteBalance.value);
            if(currentTileset) {
                currentTileset.maximumScreenSpaceError = parseFloat(detailSlider.value);
            }
        };

        detailSlider.oninput = updateUniforms;
        brightness.oninput = updateUniforms;
        contrast.oninput = updateUniforms;
        gamma.oninput = updateUniforms;
        saturation.oninput = updateUniforms;
        whites.oninput = updateUniforms;
        whiteBalance.oninput = updateUniforms;
    }

    function setupDataLayers(viewer) {
        const dataLayersList = document.getElementById('dataLayersList');
        const fileInput = document.getElementById('fileInput');
        let loadedFiles = new Map();
        const eyeIconVisible = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>`;
        const eyeIconHidden = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.44-4.75C21.27 7.61 17 4.5 12 4.5c-1.74 0-3.4.56-4.82 1.5l2.42 2.42C10.74 7.13 11.35 7 12 7zm-2.28 4.49l2.81 2.81c-.55.23-1.14.36-1.77.36-2.76 0-5-2.24-5-5 0-.63.13-1.22.36-1.77L9.72 9.49zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L21.73 22 23 20.73 3.27 3 2 4.27z"/></svg>`;
        fileInput.onchange = async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            if (loadedFiles.has(file.name)) {
                alert(`Layer "${file.name}" is already loaded.`);
                fileInput.value = '';
                return;
            }
            let loadedObject;
            const extension = file.name.split('.').pop().toLowerCase();
            try {
                if (extension === 'kml' || extension === 'kmz') {
                    loadedObject = await Cesium.KmlDataSource.load(file, { camera: viewer.scene.camera, canvas: viewer.scene.canvas });
                    await viewer.dataSources.add(loadedObject);
                } else if (extension === 'glb' || extension === 'gltf') {
                    const objectUrl = URL.createObjectURL(file);
                    loadedObject = await Cesium.Model.fromGltf({ url: objectUrl, modelMatrix: Cesium.Transforms.eastNorthUpToFixedFrame(viewer.camera.positionWC), minimumPixelSize: 128 });
                    viewer.scene.primitives.add(loadedObject);
                } else {
                    alert('Unsupported file format.');
                    return;
                }
                const listItem = document.createElement('li');
                const visibilityToggle = document.createElement('span');
                visibilityToggle.className = 'visibility-toggle';
                visibilityToggle.innerHTML = eyeIconVisible;
                visibilityToggle.onclick = (e) => {
                    e.stopPropagation();
                    loadedObject.show = !loadedObject.show;
                    visibilityToggle.innerHTML = loadedObject.show ? eyeIconVisible : eyeIconHidden;
                };
                const nameSpan = document.createElement('span');
                nameSpan.className = 'layer-name';
                nameSpan.textContent = file.name;
                listItem.ondblclick = () => viewer.flyTo(loadedObject);
                const controls = document.createElement('div');
                controls.className = 'layer-controls';
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'X';
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (loadedObject instanceof Cesium.KmlDataSource) { viewer.dataSources.remove(loadedObject); } 
                    else { viewer.scene.primitives.remove(loadedObject); }
                    listItem.remove();
                    loadedFiles.delete(file.name);
                };
                controls.appendChild(visibilityToggle);
                controls.appendChild(removeBtn);
                listItem.appendChild(nameSpan);
                listItem.appendChild(controls);
                dataLayersList.appendChild(listItem);
                loadedFiles.set(file.name, loadedObject);
                viewer.flyTo(loadedObject);
            } catch (error) {
                console.error(`Error loading file "${file.name}":`, error);
                alert(`Failed to load file: ${file.name}.`);
            }
            fileInput.value = '';
        };
    }

    function setupInteractionTools(viewer) {
        const handler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);
        const display = document.getElementById('measurement-display');
        let activeTool = null;
        let points = [];
        let allEntities = [];
        let dynamicEntity = null;

        const buttons = {
            distance: document.getElementById('distanceBtn'),
            area: document.getElementById('areaBtn'),
            volume: document.getElementById('volumeBtn'),
        };
        
        const clear = () => {
            if (activeTool) buttons[activeTool].classList.remove('active');
            activeTool = null;
            points = [];
            if (dynamicEntity) viewer.entities.remove(dynamicEntity);
            dynamicEntity = null;
        };

        const clearAll = () => {
            clear();
            allEntities.forEach(e => viewer.entities.remove(e));
            allEntities = [];
            display.textContent = 'Select a tool to begin.';
        };
        
        const activateTool = (toolName) => {
            if (activeTool === toolName) { clear(); return; }
            clear();
            activeTool = toolName;
            buttons[toolName].classList.add('active');
        };

        buttons.distance.onclick = () => activateTool('distance');
        buttons.area.onclick = () => activateTool('area');
        buttons.volume.onclick = () => activateTool('volume');
        document.getElementById('clearMeasurementsBtn').onclick = clearAll;
        
        const getPoint = (event) => viewer.scene.pickPosition(event.position || event.endPosition);

        handler.setInputAction((event) => {
            const position = getPoint(event);
            if (!activeTool || !Cesium.defined(position)) return;
            points.push(position);
            const entity = viewer.entities.add({ position, point: { pixelSize: 8, color: Cesium.Color.YELLOW, disableDepthTestDistance: Number.POSITIVE_INFINITY } });
            allEntities.push(entity);
            if (activeTool === 'distance' && points.length === 2) finalize();
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

        handler.setInputAction(() => {
            if (points.length >= 3 && (activeTool === 'area' || activeTool === 'volume')) finalize();
        }, Cesium.ScreenSpaceEventType.RIGHT_CLICK);

        handler.setInputAction((event) => {
            const position = getPoint(event);
            if (!activeTool || points.length === 0 || !Cesium.defined(position)) return;
            if (activeTool === 'distance') {
                if (!dynamicEntity) dynamicEntity = viewer.entities.add({ polyline: { positions: [], width: 3, material: Cesium.Color.YELLOW.withAlpha(0.5) }});
                dynamicEntity.polyline.positions = [points[0], position];
            } else if (activeTool === 'area' || activeTool === 'volume') {
                if (!dynamicEntity) dynamicEntity = viewer.entities.add({ polygon: { hierarchy: {}, material: Cesium.Color.YELLOW.withAlpha(0.5) } });
                dynamicEntity.polygon.hierarchy = new Cesium.PolygonHierarchy([...points, position]);
            }
        }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);

        const finalize = () => {
            let finalShape;
            if (activeTool === 'distance') {
                finalShape = viewer.entities.add({ polyline: { positions: points, width: 3, material: Cesium.Color.YELLOW } });
                display.textContent = `Distance: ${Cesium.Cartesian3.distance(points[0], points[1]).toFixed(2)} m`;
            } else if (activeTool === 'area' || activeTool === 'volume') {
                const area = calculate3DArea(points);
                let text = `Surface Area: ${area.toFixed(2)} m²`;
                if (activeTool === 'volume') {
                    const cartographics = points.map(p => Cesium.Cartographic.fromCartesian(p));
                    const minHeight = Math.min(...cartographics.map(p => p.height));
                    const maxHeight = Math.max(...cartographics.map(p => p.height));
                    text += `\nEst. Volume: ${(area * (maxHeight - minHeight)).toFixed(2)} m³`;
                }
                display.textContent = text;
                finalShape = viewer.entities.add({ polygon: { hierarchy: new Cesium.PolygonHierarchy(points), material: Cesium.Color.YELLOW.withAlpha(0.5) } });
            }
            if (finalShape) allEntities.push(finalShape);
            clear();
        };

        const calculate3DArea = (positions) => {
          if (positions.length < 3) return 0;
          let totalArea = 0;
          for (let i = 1; i < positions.length - 1; i++) {
              const v1 = Cesium.Cartesian3.subtract(positions[i], positions[0], new Cesium.Cartesian3());
              const v2 = Cesium.Cartesian3.subtract(positions[i + 1], positions[0], new Cesium.Cartesian3());
              totalArea += Cesium.Cartesian3.cross(v1, v2, new Cesium.Cartesian3()).magnitude / 2.0;
          }
          return totalArea;
        };
    }
    
    // --- Run the application ---
    document.addEventListener('DOMContentLoaded', main);
  </script>
</body>
</html>

